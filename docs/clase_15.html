<!DOCTYPE html>
<html class="writer-html5" lang="es" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clase 15: Interfaces con otros lenguajes: Fortran &mdash; documentación de Clases de Python - </title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/rtd_overrides.css" type="text/css" />
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="search" title="Búsqueda" href="search.html" />
    <link rel="next" title="Ejercicios" href="ejercicios.html" />
    <link rel="prev" title="Clase 14: Animaciones e interactividad" href="clase_14.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Clases de Python
            <img src="_static/logo.svg" class="logo" alt="Logotipo"/>
          </a>
              <div class="version">
                IB - 2023
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Buscar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Dictado de las clases</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="clase_00.html">Clase 0: Introducción al lenguaje Python orientado a Ingenierías y Física</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_01.html">Clase 1: Introducción al lenguaje</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_02.html">Clase 2: Tipos de datos y control</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_03.html">Clase 3: Tipos complejos y control de flujo</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_04.html">Clase 4: Funciones</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_05.html">Clase 5: Entrada y salida, decoradores, y errores</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_06.html">Clase 6: Programación Orientada a Objetos</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_07.html">Clase 7: Control de versiones y biblioteca standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_08.html">Clase 8: Introducción a Numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_09.html">Clase 9: Visualización</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_10.html">Clase 10: Más información sobre <strong>Numpy</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_11.html">Clase 11: Introducción al paquete Scipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html">Líneas, símbolos y colores</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html#nombres-de-ejes-y-leyendas">Nombres de ejes y leyendas</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html#dos-graficos-en-la-misma-figura">Dos gráficos en la misma figura</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html#exportar-las-figuras">Exportar las figuras</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html#graficos-en-coordenadas-polares">Gráficos en coordenadas polares</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html#otros-graficos">Otros gráficos</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html#histogramas">Histogramas</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html#ejercicio-tasa-de-natalidad-en-argentina">Ejercicio: Tasa de natalidad en Argentina</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html#histogramas-en-2d">Histogramas en 2D</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html#graficos-de-contornos">Gráficos de contornos</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_12.html#superficies-y-contornos">Superficies y contornos</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_13.html">Clase 13: Interpolación y ajuste de curvas (fiteo)</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_14.html">Clase 14: Animaciones e interactividad</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Clase 15: Interfaces con otros lenguajes: Fortran</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ejemplo-1-rotacion-de-vectores">Ejemplo 1: Rotación de vectores</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#importando-desde-un-modulo-en-un-archivo">Importando desde un módulo en un archivo</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#interfaces-con-fortran">Interfaces con Fortran</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#primer-ejemplo-nuestro-codigo">Primer ejemplo: Nuestro código</a></li>
<li class="toctree-l3"><a class="reference internal" href="#f2py">F2PY</a></li>
<li class="toctree-l3"><a class="reference internal" href="#segundo-ejemplo-codigo-heredado">Segundo Ejemplo: Código heredado</a></li>
<li class="toctree-l3"><a class="reference internal" href="#f2py-para-codigo-en-c">F2PY para código en C</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#interfaces-con-otros-lenguajes-c">Interfaces con otros lenguajes: C</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Primer ejemplo: Nuestro código</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ctypes">CTypes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#interfaces-con-clases-en-c">Interfaces con clases en C++</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">CTypes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Ejercicios de Clase</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ejercicios.html">Ejercicios</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="entregas_ejercicios.html">Entrega de ejercicios</a></li>
<li class="toctree-l1"><a class="reference internal" href="programa_detalle.html">Programa Detallado</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Clases de Python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Clase 15: Interfaces con otros lenguajes: Fortran</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/clase_15.rst.txt" rel="nofollow"> Ver código fuente de la página</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="clase-15-interfaces-con-otros-lenguajes-fortran">
<span id="clase-15"></span><h1>Clase 15: Interfaces con otros lenguajes: Fortran<a class="headerlink" href="#clase-15-interfaces-con-otros-lenguajes-fortran" title="Permalink to this heading"></a></h1>
<section id="ejemplo-1-rotacion-de-vectores">
<h2>Ejemplo 1: Rotación de vectores<a class="headerlink" href="#ejemplo-1-rotacion-de-vectores" title="Permalink to this heading"></a></h2>
<p>Supongamos que queremos resolver el problema de la rotación de vectores
en el espacio usando los <a class="reference external" href="https://mathworld.wolfram.com/EulerAngles.html">tres ángulos de
Euler</a>.</p>
<p>Dado un array con los tres ángulos de Euler, calculamos la matriz de
rotación (de 3 x 3), y la aplicamos (esto es, multiplicamos) a un
arreglo de <em>N</em> vectores.</p>
<p>En una primer versión, podemos hacerlo en Python directamente en el
notebook:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
  <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cy</span>
  <span class="k">return</span> <span class="n">R</span>


<span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Ángulos de Euler</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># Definimos N vectores tridimensionales</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
</pre></div>
</div>
<p>Si ya tenemos un módulo donde están programadas las funciones necesarias</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># %load rotacion_p.py</span>
<span class="c1">#! /usr/bin/ipython3</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
  <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cy</span>
  <span class="k">return</span> <span class="n">R</span>


<span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<p>es fácil utilizarlas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Ángulos de Euler</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># Definimos N vectores tridimensionales</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
<section id="importando-desde-un-modulo-en-un-archivo">
<h3>Importando desde un módulo en un archivo<a class="headerlink" href="#importando-desde-un-modulo-en-un-archivo" title="Permalink to this heading"></a></h3>
<p>También podemos tener las funciones para la rotación en un módulo
<code class="docutils literal notranslate"><span class="pre">rotaciones.py</span></code>. Recordemos cómo se importarían en este caso</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pwd</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">../</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_python</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rotaciones</span> <span class="k">as</span> <span class="nn">rotp</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">rotp</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">yp</span> <span class="o">=</span> <span class="n">rotp</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">yp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="interfaces-con-fortran">
<h2>Interfaces con Fortran<a class="headerlink" href="#interfaces-con-fortran" title="Permalink to this heading"></a></h2>
<p>Veamos cómo trabajar si tenemos el código para realizar las rotaciones
en Fortran</p>
<section id="primer-ejemplo-nuestro-codigo">
<h3>Primer ejemplo: Nuestro código<a class="headerlink" href="#primer-ejemplo-nuestro-codigo" title="Permalink to this heading"></a></h3>
<p>El código en Fortran que tenemos es:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">function </span><span class="n">rotate</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">N</span><span class="w"></span>
<span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">theta</span><span class="w"></span>
<span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">N</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">v</span><span class="w"></span>
<span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
<span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">R</span><span class="w"></span>
<span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">cy</span><span class="p">,</span><span class="w"> </span><span class="n">cz</span><span class="p">,</span><span class="w"> </span><span class="n">sx</span><span class="p">,</span><span class="w"> </span><span class="n">sy</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="w"></span>

<span class="w">  </span><span class="c">! Senos y Cosenos de los tres ángulos de Euler</span>
<span class="w">  </span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="n">cz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="n">sx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="n">sy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="n">sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="c">! Matriz de rotación</span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cx</span><span class="o">*</span><span class="n">cz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sx</span><span class="o">*</span><span class="n">cy</span><span class="o">*</span><span class="n">sz</span><span class="w"></span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cx</span><span class="o">*</span><span class="n">sz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sx</span><span class="o">*</span><span class="n">cy</span><span class="o">*</span><span class="n">cz</span><span class="w"></span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sx</span><span class="o">*</span><span class="n">sy</span><span class="w"></span>

<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">sx</span><span class="o">*</span><span class="n">cz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cx</span><span class="o">*</span><span class="n">cy</span><span class="o">*</span><span class="n">sz</span><span class="w"></span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">sx</span><span class="o">*</span><span class="n">sz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cx</span><span class="o">*</span><span class="n">cy</span><span class="o">*</span><span class="n">cz</span><span class="w"></span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cx</span><span class="o">*</span><span class="n">sy</span><span class="w"></span>

<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sy</span><span class="o">*</span><span class="n">sz</span><span class="w"></span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">sy</span><span class="o">*</span><span class="n">cz</span><span class="w"></span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cy</span><span class="w"></span>

<span class="w">  </span><span class="c">! Aplicamos la rotación</span>
<span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">matmul</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"></span>
<span class="k">end function </span><span class="n">rotate</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">../</span><span class="n">interfacing_F</span>
</pre></div>
</div>
</section>
<section id="f2py">
<h3>F2PY<a class="headerlink" href="#f2py" title="Permalink to this heading"></a></h3>
<p>F2PY -Fortran to Python interface generator- es una utilidad que permite
generar una interface para utilizar funciones y datos definidos en
Fortran desde Python.</p>
<p>Información sobre la interfaz entre Fotran y Python, y en particular
sobre F2PY, puede encontrarse en:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://scipy-cookbook.readthedocs.io/items/idx_interfacing_with_other_languages.html">Scipy
cookbook</a></p></li>
<li><p><a class="reference external" href="https://docs.scipy.org/doc/numpy-dev/f2py/index.html">F2PY Users Guide and Reference
Manual</a></p></li>
<li><p><a class="reference external" href="http://www.fortran90.org/src/best-practices.html#interfacing-with-python">Fortran Best
Practices</a></p></li>
<li><p><a class="reference external" href="http://websrv.cs.umt.edu/isis/index.php/F2py_example">http://websrv.cs.umt.edu/isis/index.php/F2py_example</a></p></li>
</ul>
<p>El primer paso es utilizar esta utilidad:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ f2py3 -c rotacion.f90 -m rotacion_f
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!f2py3 -c rotacion.f90 -m rotacion_f
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rotacion_f</span> <span class="kn">import</span> <span class="n">rotaciones</span> <span class="k">as</span> <span class="n">rotf</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">yf</span> <span class="o">=</span> <span class="n">rotf</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">yf</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">yf</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>Veamos qué es exactamente lo que importamos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">rotf</span><span class="o">.</span><span class="n">rotate</span><span class="p">)</span>
</pre></div>
</div>
<p>Como vemos, estamos usando la función <code class="docutils literal notranslate"><span class="pre">rotate</span></code> definida en Fortran.
Notar que: * Tiene tres argumentos. * Dos argumentos requeridos:
<code class="docutils literal notranslate"><span class="pre">angles</span></code> y <code class="docutils literal notranslate"><span class="pre">v</span></code> * Un argumento, correspondiente a la dimensión <code class="docutils literal notranslate"><span class="pre">n</span></code>
que F2PY automáticamente detecta como opcional.</p>
</section>
<section id="segundo-ejemplo-codigo-heredado">
<h3>Segundo Ejemplo: Código heredado<a class="headerlink" href="#segundo-ejemplo-codigo-heredado" title="Permalink to this heading"></a></h3>
<p>La conversión que realizamos con f2py3 la podríamos haber realizado en
dos pasos:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ f2py3 rotacion.f90 -m rotacion_f -h rotacion.pyf
$ f2py3 -c rotacion.pyf -m rotacion_f
</pre></div>
</div>
<p>En el primer paso se crea un archivo <em>signature</em> que después se utiliza
para crear el módulo que llamaremos desde <strong>Python</strong>. Haciéndolo en dos
pasos nos permite modificar el texto del archivo <em>.pyf</em> antes de
ejecutar el segundo comando.</p>
<p>Esto es útil cuando el código original no es lo suficientemente
“moderno”, no tiene toda la información necesaria sobre los argumentos o
es un código que uno no quiere o puede editar. Veamos que forma tienen
con un ejemplo más simple (tomado de la <a class="reference external" href="https://docs.scipy.org/doc/numpy-dev/f2py/getting-started.html">guía de
usuario</a>):</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="k">SUBROUTINE </span><span class="n">FIB</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="n">C</span><span class="w"></span>
<span class="n">C</span><span class="w">     </span><span class="n">CALCULATE</span><span class="w"> </span><span class="n">FIRST</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">FIBONACCI</span><span class="w"> </span><span class="n">NUMBERS</span><span class="w"></span>
<span class="n">C</span><span class="w"></span>
<span class="w">      </span><span class="kt">INTEGER </span><span class="n">N</span><span class="w"></span>
<span class="w">      </span><span class="kt">REAL</span><span class="o">*</span><span class="mi">8</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">DO </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="w"></span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span><span class="w"></span>
<span class="w">         </span><span class="n">ELSEIF</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="w"></span>
<span class="w">         </span><span class="k">ELSE</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="k">ENDIF</span>
<span class="k">      ENDDO</span>
<span class="k">      END</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!f2py3 --overwrite-signature fib1.f -m fib1 -h fib1.pyf
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!cat fib1.pyf
</pre></div>
</div>
<p>El contenido del archivo <code class="docutils literal notranslate"><span class="pre">fib1.pyf</span></code> es:</p>
<div class="highlight-fortran90 notranslate"><div class="highlight"><pre><span></span>python module fib1 ! in
    interface  ! in :fib1
        subroutine fib(a,n) ! in :fib1:fib1.f
            real*8 dimension(n) :: a
            integer, optional,check(len(a)&gt;=n),depend(a) :: n=len(a)
        end subroutine fib
    end interface
end python module fib1
</pre></div>
</div>
<p>Este código indica que tenemos una subrutina que toma dos argumentos: -
<code class="docutils literal notranslate"><span class="pre">a</span></code> es un array - <code class="docutils literal notranslate"><span class="pre">n</span></code> es un entero opcional, que tiene que ser mayor
que <code class="docutils literal notranslate"><span class="pre">len(a)</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!f2py3  -c fib1.pyf fib1.f
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fib1</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>Esta es una de las características de F2PY: hace un chequeo básico de
los argumentos. Hay otro error que no llega a atrapar: Si le pasamos un
array que no es del tipo indicado, falla (sin avisar). Éste claramente
no es el comportamiento deseado:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>Vamos a modificar el archivo de <em>signature</em> para enseñarle dos cosas:</p>
<ul class="simple">
<li><p>El entero es un argumento de entrada (requerido)</p></li>
<li><p>El <em>array</em> <code class="docutils literal notranslate"><span class="pre">a</span></code> es un archivo de salida <strong>exclusivamente</strong>. Entonces
no debemos dárselo. La parte <code class="docutils literal notranslate"><span class="pre">dimension(n)</span></code> y <code class="docutils literal notranslate"><span class="pre">depend(n)</span></code> indica
que debe crear un vector de ese tamaño.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!cat fib1.pyf
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!cat fib2.pyf
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!f2py3  -c fib2.pyf fib1.f &gt; /dev/null
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fib2</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fib2</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fib2</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">fib2</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="mi">14</span><span class="p">))</span>
</pre></div>
</div>
<p>La segunda manera de arreglar este problema, en lugar de modificar el
archivo de <em>signature</em> podría haber sido modificar el código (o hacer
una rutina intermedia). Agregando comentarios de la forma <code class="docutils literal notranslate"><span class="pre">Cf2py</span></code> no
influimos en la compilación <code class="docutils literal notranslate"><span class="pre">Fortran</span></code> pero F2PY los reconoce. En este
caso le damos la información sobre la intención de los argumentos en el
código:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="k">SUBROUTINE </span><span class="n">FIB</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="n">C</span><span class="w"></span>
<span class="n">C</span><span class="w">     </span><span class="n">CALCULATE</span><span class="w"> </span><span class="n">FIRST</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">FIBONACCI</span><span class="w"> </span><span class="n">NUMBERS</span><span class="w"></span>
<span class="n">C</span><span class="w"></span>
<span class="w">      </span><span class="kt">INTEGER </span><span class="n">N</span><span class="w"></span>
<span class="w">      </span><span class="kt">REAL</span><span class="o">*</span><span class="mi">8</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="w"></span>
<span class="n">Cf2py</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="n">Cf2py</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="n">Cf2py</span><span class="w"> </span><span class="n">depend</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="w">      </span><span class="k">DO </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="w"></span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span><span class="w"></span>
<span class="w">         </span><span class="n">ELSEIF</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="w"></span>
<span class="w">         </span><span class="k">ELSE</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="k">ENDIF</span>
<span class="k">      ENDDO</span>
<span class="k">      END</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!f2py3  -c fib3.f -m fib3 &gt; /dev/null
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fib3</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fib3</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">fib2</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<p>como vemos, son exactamente iguales.</p>
</section>
<section id="f2py-para-codigo-en-c">
<h3>F2PY para código en C<a class="headerlink" href="#f2py-para-codigo-en-c" title="Permalink to this heading"></a></h3>
<p>Es posible usar F2PY para código escrito en C, pero en ese caso debemos
escribir el <em>signature file</em> a mano.</p>
<p>Para código en C es conveniente utilizar <strong>Cython</strong>. Cython es un
lenguaje de programación pensado para hacer más fácil escribir
extensiones a Python en C. Uno escribe el código en Cython, y luego es
traducido a C, con optimizaciones.</p>
<p><strong>Cython</strong> también puede utilizarse con Fortran de una manera similar a
cómo se usa con C. Para más información ver la <a class="reference external" href="http://docs.cython.org/en/latest/index.html">documentación
oficial</a></p>
</section>
</section>
<section id="interfaces-con-otros-lenguajes-c">
<h2>Interfaces con otros lenguajes: C<a class="headerlink" href="#interfaces-con-otros-lenguajes-c" title="Permalink to this heading"></a></h2>
<p>Existen varias formas de utilizar bibliotecas o códigos hechos en C
desde Python. Nosotros veremos el uso de <code class="docutils literal notranslate"><span class="pre">Ctypes</span></code>, sin embargo existen
otras alternativas como <a class="reference external" href="https://cython.org/">Cython</a>,
<a class="reference external" href="https://cffi.readthedocs.io/en/latest/">CFFI</a>,
<a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">pybind11</a> y
<a class="reference external" href="https://www.boost.org/doc/libs/1_70_0/libs/python/doc/html/index.html">Boost.Python</a>.</p>
<p>Seguimos con el ejemplo de la rotación de vectores. Por completitud,
agregamos la funciones en Python para comparar</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pwd</span>
</pre></div>
</div>
<p>Si ya tenemos un módulo donde están programadas las funciones necesarias</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
  <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cy</span>
  <span class="k">return</span> <span class="n">R</span>


<span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Ángulos de Euler</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># Definimos N vectores tridimensionales</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># y= rotp.rotate(angle, v)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
<p>Veamos cómo trabajar si tenemos el código para realizar las rotaciones
en C.</p>
<section id="id1">
<h3>Primer ejemplo: Nuestro código<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>El código en C que tenemos es:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">m3x3</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">v3</span><span class="p">;</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>

<span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rotate</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">angles</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">){</span><span class="w"></span>

<span class="w">        </span><span class="n">m3x3</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">N</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">v3</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="c1">// p = &amp;y[i*3];</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matmul3</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="c1">// printf(&quot;%6.3f %6.3f %6.3f \n&quot;,y[i*3+0],y[i*3+1],y[i*3+2]);</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>


<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">../</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_C</span>
</pre></div>
</div>
</section>
<section id="ctypes">
<h3>CTypes<a class="headerlink" href="#ctypes" title="Permalink to this heading"></a></h3>
<p>No vamos a usar directamente <code class="docutils literal notranslate"><span class="pre">Ctypes</span></code>, sino a través de <code class="docutils literal notranslate"><span class="pre">NumPy</span></code>, que
provee algunas funciones convenientes para acceder al código C.</p>
<p>El primer paso es compilar nuestro código y generar una biblioteca:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ gcc -fpic -Wall -shared rotacion.c -o librotacion.so
</pre></div>
</div>
<p>Si uno trabaja en Windows con <a class="reference external" href="https://visualstudio.microsoft.com/es/vs/features/cplusplus/">MS
C++</a>,
generará una dll</p>
<div class="highlight-cmd notranslate"><div class="highlight"><pre><span></span>cl.exe -c rotacion.c
link.exe /DLL /OUT:rotacion.dll
</pre></div>
</div>
<p>Si en cambio <a class="reference external" href="https://www.msys2.org/">instaló gcc</a>, puede usar el
comando previo.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!gcc -fpic -Wall -shared rotacion.c -o librotacion.so
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!ls
</pre></div>
</div>
<p>En segundo lugar, importamos el módulo <code class="docutils literal notranslate"><span class="pre">ctypeslib</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy.ctypeslib</span> <span class="k">as</span> <span class="nn">ctl</span>
</pre></div>
</div>
<p>Este módulo nos provee de la función <code class="docutils literal notranslate"><span class="pre">load_library</span></code> para importar la
biblioteca</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">ctl</span><span class="o">.</span><span class="n">load_library</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rotc</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="n">load_library</span><span class="p">(</span><span class="s1">&#39;librotacion.so&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Una vez cargada la biblioteca, tenemos que definir adecuadamente cómo
pasar los argumentos a la función <code class="docutils literal notranslate"><span class="pre">rotate</span></code> de C:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rotate</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">angles</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Para eso se utiliza la función <code class="docutils literal notranslate"><span class="pre">argtypes</span></code> que recibe una lista de
tipos. Notemos que los dos primeros argumentos son arreglos de C (o sea,
punteros), mientras que el último es un entero.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">npflags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C_CONTIGUOUS&#39;</span><span class="p">]</span>   <span class="c1"># Require a C contiguous array in memory</span>

<span class="n">float_1d_type</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">npflags</span><span class="p">)</span> <span class="c1"># Puntero a float, 1D</span>
<span class="n">float_2d_type</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">npflags</span><span class="p">)</span> <span class="c1"># Puntero a float, 2D</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">float_1d_type</span><span class="p">)</span>
</pre></div>
</div>
<p>Con estos tipos de datos, defino los tipos de argumentos, que son tres
en total. El último es un dato de tipo entero, para lo cual se usa
directamente <code class="docutils literal notranslate"><span class="pre">c_intp</span></code>. Para definir el tipo de argumentos de entrada a
la función <code class="docutils literal notranslate"><span class="pre">rotc.rotate</span></code> usamos el método <code class="docutils literal notranslate"><span class="pre">argtypes</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rotc</span><span class="o">.</span><span class="n">rotate</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span>  <span class="p">[</span><span class="n">float_1d_type</span><span class="p">,</span> <span class="n">float_2d_type</span><span class="p">,</span> <span class="n">ctl</span><span class="o">.</span><span class="n">c_intp</span><span class="p">]</span>
</pre></div>
</div>
<p>Hagamos un ejemplo sencillo con N=2</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># Ángulos de Euler</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="c1"># Definimos N vectores tridimensionales</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>Las funciones que dispongo en C reciben tipos <code class="docutils literal notranslate"><span class="pre">float</span></code>, es decir que me
tengo que asegurar esto a través del método <code class="docutils literal notranslate"><span class="pre">astype</span></code>.</p>
<p>Ahora tenemos que definir el tipo de dato de salida, que retorna C a
través de un puntero a float, <code class="docutils literal notranslate"><span class="pre">float*</span></code>. Para esto usamos el método
<code class="docutils literal notranslate"><span class="pre">restype</span></code>. Como a priori no sé qué tipo de rango tiene mi arreglo de
salida, tengo que definirlo explícitamente.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rotc</span><span class="o">.</span><span class="n">rotate</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>Hay que tener precaución con el manejo de arreglos, que es muy distinto
en C y Python. En Python son objetos, de los cuales yo puedo tener
distintas vistas, slices, etc. Hay que recordar que en principio estas
son formas de acceder al mismo objeto, pero no se pueden traducir
directamente a C, que necesita un arreglo contiguo de datos.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">vt</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</pre></div>
</div>
<p>Veamos, v es un arreglo de 3 filas y 2 columnas, que contiene <em>dos</em>
vectores de tres dimensiones que se desean rotar, organizados como
columnas. Esto <em>no</em> es lo que necesita mi arreglo en C, que es tiene los
vectores organizados contiguamente en un solo arreglo unidimensional.
Entonces, tengo que transformarlo. Para eso usamos el <code class="docutils literal notranslate"><span class="pre">.T</span></code>. Ojo que
además, hay que crear un objeto nuevo con <code class="docutils literal notranslate"><span class="pre">copy()</span></code>, sino es una vista
del mismo objeto <code class="docutils literal notranslate"><span class="pre">v</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">angle90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">angle90</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">yf</span> <span class="o">=</span> <span class="n">rotc</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle90</span><span class="p">,</span>
                      <span class="n">vt</span><span class="p">,</span>
                      <span class="n">N</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">angle90</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># suppress controla cómo print va a escribir los números de punto flotante.</span>

<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">yf</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">yf</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="interfaces-con-clases-en-c">
<h2>Interfaces con clases en C++<a class="headerlink" href="#interfaces-con-clases-en-c" title="Permalink to this heading"></a></h2>
<p>El ejemplo original está
<a class="reference external" href="https://stackoverflow.com/questions/602580/how-can-i-use-c-class-in-python">acá</a>
que sigue <a class="reference external" href="https://www.auctoris.co.uk/2017/04/29/calling-c-classes-from-python-with-ctypes/">este
ejemplo</a>:</p>
<p>El código en C++ que tenemos es:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Test</span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="n">Test</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">setInt</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">getInt</span><span class="p">(){</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">../</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_Cpp</span>
</pre></div>
</div>
<p>La implementación de Python que estamos usando está escrita en C, de
modo tal que tenemos que exportar las funciones de la clase <code class="docutils literal notranslate"><span class="pre">Test</span></code> en
C++ en el código fuente de la siguiente manera:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// include below each method you want to make visible outside</span>
<span class="w">    </span><span class="n">Test</span><span class="o">*</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Test</span><span class="p">(</span><span class="n">k</span><span class="p">);}</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setInt</span><span class="p">(</span><span class="n">Test</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">setInt</span><span class="p">(</span><span class="n">k</span><span class="p">);}</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">getInt</span><span class="p">(</span><span class="n">Test</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="o">-&gt;</span><span class="n">getInt</span><span class="p">();}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Add the declaration &#39;__declspec(dllexport)&#39; before each function in Windows</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>La declaración <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span></code> indican al compilador de C++ que genere
código compatible con C de todas las funciones incluídas en el bloque.</p>
<section id="id2">
<h3>CTypes<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>Vamos ahora a usar directamente <code class="docutils literal notranslate"><span class="pre">Ctypes</span></code>. Como antes, el primer paso
es compilar nuestro código y generar una biblioteca:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ g++ -fpic -shared test.cpp -o libtest.so
</pre></div>
</div>
<p>Si uno trabaja en Windows, generará una dll</p>
<div class="highlight-cmd notranslate"><div class="highlight"><pre><span></span>cl.exe -c test.cpp
link.exe /DLL /OUT:test.dll
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span># !gcc -fpic -Wall -shared rotacion.c -o librotacion.so
!g++ -fpic -shared test.cpp -o libtest.so
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!ls
</pre></div>
</div>
<p>En segundo lugar, importamos el módulo <code class="docutils literal notranslate"><span class="pre">ctypes</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ctypes</span>
</pre></div>
</div>
<p>Este módulo nos provee de la función <code class="docutils literal notranslate"><span class="pre">CDLL</span></code> para importar la
biblioteca</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lib</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s1">&#39;./libtest.so&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Ahora vamos a crear una clase en Python equivalente a la que teníamos en
C++. Al igual que en el caso de C, tenemos que establecer los tipos de
datos de entrada (via el método <code class="docutils literal notranslate"><span class="pre">argtypes</span></code>) y salida (vía el método
<code class="docutils literal notranslate"><span class="pre">restype</span></code>) para <em>cada función de la clase</em>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Test</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Declare input and output types for each method you intend to use</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>

        <span class="n">lib</span><span class="o">.</span><span class="n">setInt</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">setInt</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>

        <span class="n">lib</span><span class="o">.</span><span class="n">getInt</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">getInt</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>

        <span class="c1"># use the C++ constructor to build the instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setInt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">setInt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getInt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lib</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">T1</span> <span class="o">=</span> <span class="n">Test</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">T1</span><span class="o">.</span><span class="n">getInt</span><span class="p">())</span>
<span class="n">T1</span><span class="o">.</span><span class="n">setInt</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">T1</span><span class="o">.</span><span class="n">getInt</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">T1</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Pie de página">
        <a href="clase_14.html" class="btn btn-neutral float-left" title="Clase 14: Animaciones e interactividad" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Anterior</a>
        <a href="ejercicios.html" class="btn btn-neutral float-right" title="Ejercicios" accesskey="n" rel="next">Siguiente <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Derechos de autor IB - 2023, Juan Fiol.</p>
  </div>

  Compilado con <a href="https://www.sphinx-doc.org/">Sphinx</a> usando un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">tema</a>
    proporcionado por <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>